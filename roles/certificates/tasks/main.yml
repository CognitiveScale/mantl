---

- name: gather ec2 facts 
  ec2_facts: 
  tags:
    - certificates

- name: set private_ipv4 compatible with terraform.py inventory
  set_fact:
    private_ipv4: "{{ ansible_ec2_local_ipv4 }}"
  when: "{{ inventory_hostname != 'localhost' }}"
  tags:
    - certificates

- debug: msg="{{dns}} {{ip}}"
  tags:
    - certificates

- name: deploy CA public and private keys
  sudo: yes
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
  with_items:
    # CA public key
    - src: ssl/cacert.pem
      dest: /etc/pki/CA/ca.cert
    - src: ssl/cacert.pem # https://github.com/asteris-llc/mantl-packaging/issues/90
      dest: /etc/pki/CA/cacert.pem
    - src: ssl/cacert.pem
      dest: /etc/pki/ca-trust/source/anchors/cacert.pem
    # CA private key
    - src: ssl/private/cakey.pem
      dest: /etc/pki/CA/ca.key
    - src: ssl/private/cakey.pem
      dest: /etc/pki/CA/private/cakey.pem
  notify:
    - update-ca-trust
  tags:
    - certificates

- name: install generate-certificate
  sudo: yes
  yum:
    name: generate-certificate-0.0.1
    state: present
  tags:
    - certificates

- name: create certificate destination directory
  sudo: yes
  file:
    state: directory
    path: "{{ destination }}"
    owner: root
    group: root
    mode: 755
  tags:
    - certificates

# - name: backup marker file if rotating certificates
#   sudo: yes
#   command: 
#     mv "{{ destination }}/{{ prefix }}{% if prefix != '' %}.{% endif %}key" "{{ destination }}/{{ prefix }}{% if prefix != '' %}.{% endif %}key.bak"    
#   when: certificates_rotate | default('no') == "yes"
#   tags:
#     - certificates

- name: set unique_subject = no
  copy:
    dest: "/etc/pki/CA/index.txt.attr"
    content: "unique_subject = no"
    mode: 0644
  tags:
    - certificates

- name: generate certificates
  sudo: yes
  command: >
    generate-certificate
    {% if country != "" %} --country "{{ country }}" {% endif %}
    {% if state != "" %} --state "{{ state }}" {% endif %}
    {% if locality != "" %} --locality "{{ locality }}" {% endif %}
    {% if organization != "" %} --organization "{{ organization }}" {% endif %}
    {% if unit != "" %} --unit "{{ unit }}" {% endif %}
    {% if email != "" %} --email "{{ email }}" {% endif %}
    {% if dns != "" %} --dns "{{ dns | unique | join(' ') }}" {% endif %}
    {% if ip != "" %} --ip "{{ ip | unique | join(' ') }}" {% endif %}
    --location "{{ location }}"
    --destination "{{ destination }}"
  args:
    creates: "{{ destination }}/{{ prefix }}{% if prefix != '' %}.{% endif %}key"
  tags:
    - certificates
# DNS:localhost, DNS:d-lin-auw2-worker03, DNS:d-lin-auw2-worker03.node, DNS:d-lin-auw2-worker03.node.consul, DNS:*.service, DNS:*.service.consul, IP Address:127.0.0.1, IP Address:10.201.4.238
# generate-certificate --locality Austin --dns d-lin-auw2-worker02 d-lin-auw2-worker02.node d-lin-auw2-worker02.node.consul *.service *.service.consul --ip 10.201.2.26 --location d-lin-auw2-worker02.c1.io --destination /etc/pki/mantl